---
- name: Pull Keycloak image
  community.docker.docker_image:
    name: quay.io/keycloak/keycloak:20.0.1
    repository: "{{ docker_registry_url }}/keycloak:20.0.1"
    source: pull
  when: inventory_hostname == groups['swarm_managers'][0]
 
#wait for the image to be pulled 
- name: Wait for image to be pulled
  community.docker.docker_image_info:
  name: "{{ docker_registry_url }}/keycloak:20.0.1"
  register: keycloak_image
  until: keycloak_image.images | length > 0
  retries: 10
  delay: 5
  when: inventory_hostname == groups['swarm_managers'][0]

- name: Push keycloack to registry
  community.docker.docker_image:
    name: "{{ docker_registry_url }}/keycloak:20.0.1"
    source: local
    repository: "{{ docker_registry_url }}/keycloak:20.0.1"
    push: true
    debug: true
  when: inventory_hostname == groups['swarm_managers'][0]

- name: Start Keycloak
  community.docker.docker_swarm_service:
    name: "keycloak"
    image: "{{ docker_registry_url }}/keycloak:20.0.1"
    env:
      KEYCLOAK_CONTAINER_NAME: "keycloak"
      KEYCLOAK_ADMIN: "{{ keycloak_username }}"
      KEYCLOAK_ADMIN_PASSWORD: "{{ keycloak_password }}" 
      KEYCLOACK_DB_URL: "jdbc:postgresql://{{ansible_host}}:5432/keycloak"
      KEYCLOACK_DB_PASSWORD: "{{postgres_password}}"
    publish:
      - mode: host
        published_port: 8080
        target_port: 8080
    restart_config:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
    networks:
      - name: host
    args: "start-dev"
  when: inventory_hostname == groups['swarm_managers'][0]